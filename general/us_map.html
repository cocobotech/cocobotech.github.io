<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive US Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #map-container {
            width: 95vw;
            height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        
        .state {
            stroke: #2c3e50;
            stroke-width: 2.5;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .state:hover {
            fill: #ffcccb !important;
            filter: 
                drop-shadow(0 15px 30px rgba(231, 76, 60, 0.5))
                drop-shadow(0 0 20px rgba(255, 100, 100, 0.8))
                drop-shadow(0 0 40px rgba(255, 150, 150, 0.4))
                brightness(1.2);
            stroke-width: 4;
            stroke: #e74c3c;
            transform: translateY(-2px);
        }
        
        .state.state-hovered {
            fill: #ffcccb !important;
            filter: 
                drop-shadow(0 15px 30px rgba(231, 76, 60, 0.5))
                drop-shadow(0 0 20px rgba(255, 100, 100, 0.8))
                drop-shadow(0 0 40px rgba(255, 150, 150, 0.4))
                brightness(1.2);
            stroke-width: 4;
            stroke: #e74c3c;
            transform: translateY(-2px);
        }
        
        .state-label {
            font-size: 11px;
            font-weight: 600;
            fill: #2c3e50;
            pointer-events: none;
            text-anchor: middle;
            user-select: none;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white;
            transition: all 0.4s ease;
        }
        
        .state-label.hovered {
            font-weight: 900;
            font-size: 13px;
            fill: #c0392b;
            filter: 
                drop-shadow(0 2px 0px rgba(192, 57, 43, 0.8))
                drop-shadow(0 4px 0px rgba(192, 57, 43, 0.6))
                drop-shadow(0 6px 0px rgba(192, 57, 43, 0.4))
                drop-shadow(0 0 15px rgba(255, 100, 100, 1))
                drop-shadow(0 0 30px rgba(255, 150, 150, 0.6));
            transform: translateY(-3px);
        }
        
        .external-label {
            font-size: 11px;
            font-weight: 600;
            fill: #2c3e50;
            cursor: pointer;
            text-shadow: 1px 1px 2px white;
            transition: all 0.3s ease;
        }
        
        .external-label.hovered {
            font-weight: 900;
            font-size: 12px;
            fill: #c0392b;
            filter: 
                drop-shadow(0 2px 0px rgba(192, 57, 43, 0.8))
                drop-shadow(0 4px 0px rgba(192, 57, 43, 0.6))
                drop-shadow(0 0 10px rgba(255, 100, 100, 0.8));
        }
        
        .label-line {
            stroke: #7f8c8d;
            stroke-width: 1.5;
            fill: none;
            pointer-events: none;
            opacity: 0.6;
            transition: all 0.3s ease;
            stroke-dasharray: 2, 4;
        }
        
        .label-line.hovered {
            stroke: #e74c3c;
            stroke-width: 3;
            stroke-dasharray: none;
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(231, 76, 60, 0.8));
        }
        
        .label-start-dot {
            fill: #7f8c8d;
            stroke: white;
            stroke-width: 1;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .label-start-dot.hovered {
            fill: #e74c3c;
            r: 4;
            filter: drop-shadow(0 0 6px rgba(231, 76, 60, 0.8));
        }
            fill: #e74c3c;
            stroke: white;
            stroke-width: 1.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .capital-dot.hovered {
            fill: #c0392b;
            r: 5;
            filter: drop-shadow(0 0 8px rgba(231, 76, 60, 0.8));
        }
        
        .capital-label {
            font-size: 8px;
            fill: #c0392b;
            font-weight: 600;
            pointer-events: none;
            text-anchor: middle;
            text-shadow: 0.5px 0.5px 1px white, -0.5px -0.5px 1px white;
            transition: all 0.3s ease;
        }
        
        .capital-label.hovered {
            font-size: 9px;
            font-weight: 800;
            filter: drop-shadow(0 0 5px rgba(192, 57, 43, 0.6));
        }
        
        .title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .info-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            color: #2c3e50;
            z-index: 10;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 12px;
            color: #2c3e50;
            z-index: 10;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div class="title">美国地图 - United States Map</div>
        <div id="loading">Loading map data...</div>
        <svg id="map" viewBox="0 0 1200 650"></svg>
        <div class="info-box">
            将鼠标悬停在州上以听到州名 | Hover over states to hear their names
        </div>
        <div class="legend">
            <div class="legend-title">图例 Legend</div>
            <div class="legend-item">
                <div class="legend-dot"></div>
                <span>州首府 State Capital</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script>
        // 州首府数据
        const capitals = {
            "Alabama": { name: "Montgomery", coords: [-86.3077, 32.3617] },
            "Alaska": { name: "Juneau", coords: [-134.4197, 58.3019] },
            "Arizona": { name: "Phoenix", coords: [-112.0740, 33.4484] },
            "Arkansas": { name: "Little Rock", coords: [-92.2896, 34.7465] },
            "California": { name: "Sacramento", coords: [-121.4944, 38.5816] },
            "Colorado": { name: "Denver", coords: [-104.9903, 39.7392] },
            "Connecticut": { name: "Hartford", coords: [-72.6859, 41.7658] },
            "Delaware": { name: "Dover", coords: [-75.5277, 39.1582] },
            "Florida": { name: "Tallahassee", coords: [-84.2807, 30.4383] },
            "Georgia": { name: "Atlanta", coords: [-84.3880, 33.7490] },
            "Hawaii": { name: "Honolulu", coords: [-157.8583, 21.3099] },
            "Idaho": { name: "Boise", coords: [-116.2023, 43.6150] },
            "Illinois": { name: "Springfield", coords: [-89.6501, 39.7817] },
            "Indiana": { name: "Indianapolis", coords: [-86.1581, 39.7684] },
            "Iowa": { name: "Des Moines", coords: [-93.6091, 41.5868] },
            "Kansas": { name: "Topeka", coords: [-95.6890, 39.0473] },
            "Kentucky": { name: "Frankfort", coords: [-84.8733, 38.2009] },
            "Louisiana": { name: "Baton Rouge", coords: [-91.1871, 30.4515] },
            "Maine": { name: "Augusta", coords: [-69.7795, 44.3106] },
            "Maryland": { name: "Annapolis", coords: [-76.4922, 38.9784] },
            "Massachusetts": { name: "Boston", coords: [-71.0589, 42.3601] },
            "Michigan": { name: "Lansing", coords: [-84.5555, 42.7325] },
            "Minnesota": { name: "Saint Paul", coords: [-93.0900, 44.9537] },
            "Mississippi": { name: "Jackson", coords: [-90.1848, 32.2988] },
            "Missouri": { name: "Jefferson City", coords: [-92.1735, 38.5767] },
            "Montana": { name: "Helena", coords: [-112.0391, 46.5891] },
            "Nebraska": { name: "Lincoln", coords: [-96.6852, 40.8136] },
            "Nevada": { name: "Carson City", coords: [-119.7674, 39.1638] },
            "New Hampshire": { name: "Concord", coords: [-71.5376, 43.2081] },
            "New Jersey": { name: "Trenton", coords: [-74.7429, 40.2206] },
            "New Mexico": { name: "Santa Fe", coords: [-105.9378, 35.6870] },
            "New York": { name: "Albany", coords: [-73.7562, 42.6526] },
            "North Carolina": { name: "Raleigh", coords: [-78.6382, 35.7796] },
            "North Dakota": { name: "Bismarck", coords: [-100.7799, 46.8083] },
            "Ohio": { name: "Columbus", coords: [-82.9988, 39.9612] },
            "Oklahoma": { name: "Oklahoma City", coords: [-97.5164, 35.4676] },
            "Oregon": { name: "Salem", coords: [-123.0351, 44.9429] },
            "Pennsylvania": { name: "Harrisburg", coords: [-76.8867, 40.2732] },
            "Rhode Island": { name: "Providence", coords: [-71.4128, 41.8240] },
            "South Carolina": { name: "Columbia", coords: [-81.0348, 34.0007] },
            "South Dakota": { name: "Pierre", coords: [-100.3364, 44.3683] },
            "Tennessee": { name: "Nashville", coords: [-86.7816, 36.1627] },
            "Texas": { name: "Austin", coords: [-97.7431, 30.2672] },
            "Utah": { name: "Salt Lake City", coords: [-111.8910, 40.7608] },
            "Vermont": { name: "Montpelier", coords: [-72.5754, 44.2601] },
            "Virginia": { name: "Richmond", coords: [-77.4360, 37.5407] },
            "Washington": { name: "Olympia", coords: [-122.9007, 47.0379] },
            "West Virginia": { name: "Charleston", coords: [-81.6326, 38.3498] },
            "Wisconsin": { name: "Madison", coords: [-89.4012, 43.0731] },
            "Wyoming": { name: "Cheyenne", coords: [-104.8202, 41.1400] }
        };

        // 东部小州需要外部标签
        const externalLabelStates = [
            "Vermont", "New Hampshire", "Massachusetts", "Rhode Island", 
            "Connecticut", "New Jersey", "Delaware", "Maryland"
        ];

        // 柔和配色方案
        const colors = [
            "#FFE5E5", "#E5F5FF", "#FFF5E5", "#E5FFE5", "#FFE5F5",
            "#E5E5FF", "#FFFFE5", "#FFE5FF", "#E5FFFF", "#F5E5FF",
            "#FFEFDB", "#DBF5FF", "#FFDBE5", "#E5FFDB", "#FFE5DB"
        ];

        let colorIndex = 0;
        const usedColors = {};

        function getColorForState(stateName) {
            if (!usedColors[stateName]) {
                usedColors[stateName] = colors[colorIndex % colors.length];
                colorIndex++;
            }
            return usedColors[stateName];
        }

        // 使用Web Speech API朗读州名
        function speakState(stateName) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(stateName);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // 加载并绘制地图
        async function loadMap() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json');
                const geojson = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                const svg = d3.select("#map");
                const width = 1200;
                const height = 650;
                
                // 创建投影
                const projection = d3.geoAlbersUsa()
                    .scale(1300)
                    .translate([width / 2 - 50, height / 2 + 30]);
                
                const path = d3.geoPath().projection(projection);
                
                // 存储元素引用
                const stateElements = {};
                const labelElements = {};
                const capitalDots = {};
                const capitalLabels = {};
                const externalLabels = {};
                const labelLines = {};
                const labelStartDots = {};
                
                // 绘制州
                geojson.features.forEach(feature => {
                    const stateName = feature.properties.name;
                    
                    const statePath = svg.append("path")
                        .datum(feature)
                        .attr("d", path)
                        .attr("class", "state")
                        .attr("fill", getColorForState(stateName))
                        .attr("data-state", stateName)
                        .attr("id", `state-${stateName.replace(/\s/g, '-')}`);
                    
                    stateElements[stateName] = statePath;
                    
                    const centroid = path.centroid(feature);
                    const useExternalLabel = externalLabelStates.includes(stateName);
                    
                    if (!useExternalLabel) {
                        // 内部标签
                        const label = svg.append("text")
                            .attr("class", "state-label")
                            .attr("x", centroid[0])
                            .attr("y", centroid[1])
                            .attr("data-state", stateName)
                            .text(stateName);
                        
                        labelElements[stateName] = label;
                    } else {
                        // 外部标签 - 完全在地图右侧外面，左对齐，再往右移动10个字的距离
                        const externalX = 1050;
                        const externalY = 120 + externalLabelStates.indexOf(stateName) * 30;
                        
                        // 起始点：标签左边往左移一个字符的位置
                        const labelStartX = externalX - 10;
                        
                        // 90度点虚线折线：从州中心 -> 垂直到标签高度 -> 水平到标签起始点
                        // 不要有往右连接的路程，直接从左边连过来
                        const line = svg.append("path")
                            .attr("class", "label-line")
                            .attr("d", `M ${centroid[0]},${centroid[1]} L ${centroid[0]},${externalY - 5} L ${labelStartX},${externalY - 5}`)
                            .attr("data-state", stateName);
                        
                        labelLines[stateName] = line;
                        
                        // 在标签起始点添加圆点
                        const startDot = svg.append("circle")
                            .attr("class", "label-start-dot")
                            .attr("cx", labelStartX)
                            .attr("cy", externalY - 5)
                            .attr("r", 3)
                            .attr("data-state", stateName);
                        
                        labelStartDots[stateName] = startDot;
                        
                        // 外部标签文字 - 左对齐
                        const extLabel = svg.append("text")
                            .attr("class", "external-label")
                            .attr("x", externalX)
                            .attr("y", externalY)
                            .attr("text-anchor", "start")
                            .attr("data-state", stateName)
                            .text(stateName);
                        
                        externalLabels[stateName] = extLabel;
                        
                        // 为外部标签添加鼠标事件
                        extLabel.on("mouseenter", function() {
                            speakState(stateName);
                            
                            // 直接为州path添加CSS类来触发样式
                            const stateElement = d3.select(`#state-${stateName.replace(/\s/g, '-')}`);
                            stateElement.classed("state-hovered", true);
                            
                            // 触发所有高亮效果
                            if (externalLabels[stateName]) {
                                externalLabels[stateName].classed("hovered", true);
                            }
                            if (labelLines[stateName]) {
                                labelLines[stateName].classed("hovered", true);
                            }
                            if (labelStartDots[stateName]) {
                                labelStartDots[stateName].classed("hovered", true);
                            }
                            if (capitalDots[stateName]) {
                                capitalDots[stateName].classed("hovered", true);
                            }
                            if (capitalLabels[stateName]) {
                                capitalLabels[stateName].classed("hovered", true);
                            }
                        })
                        .on("mouseleave", function() {
                            // 移除州的高亮类
                            const stateElement = d3.select(`#state-${stateName.replace(/\s/g, '-')}`);
                            stateElement.classed("state-hovered", false);
                            
                            // 取消所有高亮效果
                            if (externalLabels[stateName]) {
                                externalLabels[stateName].classed("hovered", false);
                            }
                            if (labelLines[stateName]) {
                                labelLines[stateName].classed("hovered", false);
                            }
                            if (labelStartDots[stateName]) {
                                labelStartDots[stateName].classed("hovered", false);
                            }
                            if (capitalDots[stateName]) {
                                capitalDots[stateName].classed("hovered", false);
                            }
                            if (capitalLabels[stateName]) {
                                capitalLabels[stateName].classed("hovered", false);
                            }
                        });
                    }
                    
                    // 添加首府标记
                    const capital = capitals[stateName];
                    if (capital) {
                        const coords = projection(capital.coords);
                        if (coords) {
                            const dot = svg.append("circle")
                                .attr("class", "capital-dot")
                                .attr("cx", coords[0])
                                .attr("cy", coords[1])
                                .attr("r", 3.5)
                                .attr("data-state", stateName);
                            
                            capitalDots[stateName] = dot;
                            
                            const capLabel = svg.append("text")
                                .attr("class", "capital-label")
                                .attr("x", coords[0])
                                .attr("y", coords[1] + 12)
                                .attr("data-state", stateName)
                                .text(capital.name);
                            
                            capitalLabels[stateName] = capLabel;
                        }
                    }
                    
                    // 添加悬停事件
                    statePath.on("mouseenter", function() {
                        speakState(stateName);
                        
                        // 高亮州标签
                        if (labelElements[stateName]) {
                            labelElements[stateName].classed("hovered", true);
                        }
                        if (externalLabels[stateName]) {
                            externalLabels[stateName].classed("hovered", true);
                        }
                        if (labelLines[stateName]) {
                            labelLines[stateName].classed("hovered", true);
                        }
                        if (labelStartDots[stateName]) {
                            labelStartDots[stateName].classed("hovered", true);
                        }
                        
                        // 高亮首府
                        if (capitalDots[stateName]) {
                            capitalDots[stateName].classed("hovered", true);
                        }
                        if (capitalLabels[stateName]) {
                            capitalLabels[stateName].classed("hovered", true);
                        }
                    })
                    .on("mouseleave", function() {
                        // 移除高亮
                        if (labelElements[stateName]) {
                            labelElements[stateName].classed("hovered", false);
                        }
                        if (externalLabels[stateName]) {
                            externalLabels[stateName].classed("hovered", false);
                        }
                        if (labelLines[stateName]) {
                            labelLines[stateName].classed("hovered", false);
                        }
                        if (labelStartDots[stateName]) {
                            labelStartDots[stateName].classed("hovered", false);
                        }
                        if (capitalDots[stateName]) {
                            capitalDots[stateName].classed("hovered", false);
                        }
                        if (capitalLabels[stateName]) {
                            capitalLabels[stateName].classed("hovered", false);
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error loading map:", error);
                document.getElementById('loading').textContent = 'Error loading map data. Please refresh.';
            }
        }

        // 初始化地图
        loadMap();
    </script>
</body>
</html>
